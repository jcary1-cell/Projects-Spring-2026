import React, { useState, useEffect, useRef } from 'react';
import { 
  BookOpen, 
  Cpu, 
  MessageSquare, 
  ShieldCheck, 
  Send, 
  RotateCcw, 
  Sparkles,
  Info,
  X,
  FileText,
  ClipboardCheck,
  Check
} from 'lucide-react';

/**
 * AI Rhetoric Lab
 * A self-contained interactive assignment exploring AI through 
 * the lenses of Tenen, Mollick, and Li.
 */
const App = () => {
  const [activeStep, setActiveStep] = useState(0);
  const [chatHistory, setChatHistory] = useState([]);
  const [userInput, setUserInput] = useState("");
  const [vectorInput, setVectorInput] = useState("");
  const [guardrailInput, setGuardrailInput] = useState("");
  const [megaPrompt, setMegaPrompt] = useState({ ethos: '', logos: '', pathos: '' });
  const [isTyping, setIsTyping] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [modalContent, setModalContent] = useState({ title: '', body: '', isReport: false });
  const [copied, setCopied] = useState(false);
  
  const scrollRef = useRef(null);

  // Scholars data
  const scholars = {
    tenen: { name: "Dennis Yi Tenen", concept: "The Mathematics of Language", quote: "Language is a pattern-matching system, not a truth-telling one." },
    mollick: { name: "Ethan Mollick", concept: "Co-Intelligence", quote: "Treat the AI as a smart but fallible intern." },
    li: { name: "Fei-Fei Li", concept: "Human-Centered AI", quote: "AI must enhance human dignity, not replace it." }
  };

  const steps = [
    { id: 'tenen', title: 'Lab 1: Vectorization', icon: <Cpu size={20} />, scholar: scholars.tenen },
    { id: 'socratic', title: 'Lab 2: Socratic Elenchus', icon: <MessageSquare size={20} />, scholar: scholars.mollick },
    { id: 'rhetoric', title: 'Lab 3: The Mega-Prompt', icon: <Sparkles size={20} />, scholar: scholars.mollick },
    { id: 'ethics', title: 'Lab 4: The Guardrails', icon: <ShieldCheck size={20} />, scholar: scholars.li }
  ];

  // Auto-scroll chat
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [chatHistory, isTyping]);

  const triggerModal = (title, body, isReport = false) => {
    setModalContent({ title, body, isReport });
    setShowModal(true);
  };

  const handleSocraticChat = async () => {
    if (!userInput.trim()) return;
    
    const newMsg = { role: 'user', content: userInput };
    setChatHistory(prev => [...prev, newMsg]);
    setUserInput("");
    setIsTyping(true);

    // Simulate AI response
    setTimeout(() => {
      const responses = [
        "That is a broad claim. By what criteria are you defining the 'value' in that sentence?",
        "If we accept your premise, does it not follow that the opposite must also be true in certain contexts?",
        "Interesting. How would Tenen's 'mathematical probability' explain that specific word choice you just used?",
        "Let's look deeper. Provide a counter-example to your last statement."
      ];
      const aiMsg = { 
        role: 'assistant', 
        content: responses[Math.floor(Math.random() * responses.length)] 
      };
      setChatHistory(prev => [...prev, aiMsg]);
      setIsTyping(false);
    }, 1200);
  };

  const generateReport = () => {
    const report = `AI RHETORIC LAB - ASSIGNMENT REPORT
Generated: ${new Date().toLocaleString()}
------------------------------------------

1. VECTORIZATION (Linguistic Boundary):
${vectorInput || "No input provided"}

2. SOCRATIC DIALOGUE (Refutation Exercise):
${chatHistory.length > 0 ? chatHistory.map(m => `[${m.role.toUpperCase()}]: ${m.content}`).join('\n') : "No dialogue recorded"}

3. THE MEGA-PROMPT CONSTRUCTOR:
- Ethos (Persona): ${megaPrompt.ethos || "Not specified"}
- Logos (Constraints): ${megaPrompt.logos || "Not specified"}
- Pathos (Impact/Tone): ${megaPrompt.pathos || "Not specified"}

4. HUMAN-CENTERED GUARDRAILS (Ethical Audit):
${guardrailInput || "No input provided"}`;

    triggerModal("Final Assignment Data", report, true);
  };

  const copyToClipboard = (text) => {
    // Robust copy method for various deployment environments
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(() => {
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      });
    } else {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      textArea.style.top = "0";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        setCopied(true);
      } catch (err) {
        console.error('Fallback copy failed', err);
      }
      document.body.removeChild(textArea);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans p-4 md:p-8 selection:bg-blue-500/30 overflow-x-hidden">
      <style>{`
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-section { animation: fadeIn 0.4s ease-out forwards; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #334155; }
      `}</style>

      {/* Header */}
      <header className="max-w-6xl mx-auto mb-8 border-b border-slate-800 pb-6">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-400 via-indigo-400 to-emerald-400 bg-clip-text text-transparent">
              AI Rhetoric Lab
            </h1>
            <p className="text-slate-400 mt-1 font-medium tracking-tight">Interactive Application of Critical AI Scholarship</p>
          </div>
          <div className="bg-slate-900 px-4 py-2 rounded-full border border-slate-800 text-xs font-mono text-blue-400 flex items-center gap-2">
            <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
            v1.2.0-production
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        {/* Navigation */}
        <nav className="lg:col-span-1 space-y-3">
          {steps.map((step, index) => (
            <button
              key={step.id}
              onClick={() => setActiveStep(index)}
              className={`w-full flex items-center gap-3 p-4 rounded-xl transition-all duration-200 border text-left ${
                activeStep === index 
                ? 'bg-blue-600 border-blue-400 text-white shadow-lg shadow-blue-900/20' 
                : 'bg-slate-900 border-slate-800 text-slate-400 hover:bg-slate-800'
              }`}
            >
              <div className={activeStep === index ? 'text-white' : 'text-blue-500'}>
                {step.icon}
              </div>
              <span className="font-semibold text-sm">{step.title}</span>
            </button>
          ))}
          
          <div className="mt-8 p-5 bg-slate-900/80 rounded-2xl border border-slate-800 relative overflow-hidden group">
            <div className="absolute top-0 right-0 p-2 opacity-5 group-hover:opacity-10 transition-opacity">
              <BookOpen size={48} />
            </div>
            <h3 className="text-[10px] uppercase tracking-[0.2em] text-slate-500 font-black mb-3 flex items-center gap-2">
              <Info size={14} className="text-blue-400" /> Key Concept
            </h3>
            <p className="text-sm font-bold text-blue-400 mb-1">{steps[activeStep].scholar.name}</p>
            <p className="text-xs text-slate-300 leading-relaxed italic">"{steps[activeStep].scholar.quote}"</p>
          </div>
        </nav>

        {/* Lab Content Area */}
        <section className="lg:col-span-3 bg-slate-900/40 rounded-3xl border border-slate-800 shadow-xl backdrop-blur-md overflow-hidden flex flex-col min-h-[600px]">
          
          {activeStep === 0 && (
            <div className="p-8 fade-in-section h-full overflow-y-auto custom-scrollbar">
              <h2 className="text-2xl font-bold mb-4 flex items-center gap-3">
                <Cpu className="text-blue-400" /> Lab 1: Vectorization
              </h2>
              <p className="text-slate-300 mb-8 leading-relaxed">
                Dennis Yi Tenen notes that Large Language Models operate via <strong>vectorized probability</strong>. 
                They don't know "truth"; they know "neighboring patterns."
              </p>
              
              <div className="space-y-8">
                <div className="bg-slate-950 p-6 rounded-2xl border border-slate-800 relative group">
                  <span className="absolute -top-3 left-4 bg-slate-950 px-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Base Query</span>
                  <code className="text-emerald-400 block font-mono text-sm group-hover:text-emerald-300 transition-colors">
                    "Write a 500-word essay on the meaning of liberty."
                  </code>
                </div>
                
                <div className="bg-slate-900 p-6 rounded-2xl border border-blue-500/20 shadow-inner">
                  <label className="block text-xs font-black text-blue-400 uppercase tracking-widest mb-4">Boundary-Setting Prompt</label>
                  <p className="text-sm text-slate-400 mb-4 italic">
                    Exercise: Write a prompt that forces the AI to map "liberty" against a specific semantic anchor (e.g., 17th-century piracy or modern data privacy laws).
                  </p>
                  <textarea 
                    value={vectorInput}
                    onChange={(e) => setVectorInput(e.target.value)}
                    className="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-700 min-h-[120px]"
                    placeholder="Compare the semantic neighbors of 'liberty' in the context of..."
                  />
                </div>
              </div>
            </div>
          )}

          {activeStep === 1 && (
            <div className="flex flex-col h-full fade-in-section">
              <div className="p-6 border-b border-slate-800 bg-slate-900/60 flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold flex items-center gap-3">
                    <MessageSquare className="text-emerald-400" /> Lab 2: Socratic Elenchus
                  </h2>
                  <p className="text-sm text-slate-400 mt-1">Refuting the AI's first generic answer.</p>
                </div>
                {chatHistory.length > 0 && (
                   <button onClick={() => setChatHistory([])} className="text-slate-600 hover:text-red-400 transition-colors">
                     <RotateCcw size={16} />
                   </button>
                )}
              </div>
              
              <div ref={scrollRef} className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar bg-slate-950/20">
                {chatHistory.length === 0 && (
                  <div className="flex flex-col items-center justify-center py-20 text-slate-700">
                    <MessageSquare size={48} strokeWidth={1} className="mb-4 opacity-20" />
                    <p className="text-sm font-medium">Initiate a dialogue to begin the exercise...</p>
                  </div>
                )}
                {chatHistory.map((msg, i) => (
                  <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[80%] p-4 rounded-2xl shadow-sm ${
                      msg.role === 'user' 
                      ? 'bg-blue-600 text-white rounded-br-none' 
                      : 'bg-slate-800 text-slate-200 rounded-bl-none border border-slate-700'
                    }`}>
                      <p className="text-sm leading-relaxed">{msg.content}</p>
                    </div>
                  </div>
                ))}
                {isTyping && (
                  <div className="flex gap-1.5 items-center px-4 py-2 bg-slate-800/40 w-max rounded-full border border-slate-700/50">
                    <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce"></div>
                    <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                    <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce [animation-delay:0.4s]"></div>
                  </div>
                )}
              </div>

              <div className="p-4 bg-slate-950/60 border-t border-slate-800">
                <div className="flex gap-3 max-w-4xl mx-auto">
                  <input 
                    value={userInput}
                    onChange={(e) => setUserInput(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleSocraticChat()}
                    placeholder="Challenge the AI's logic..."
                    className="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-5 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                  />
                  <button 
                    onClick={handleSocraticChat}
                    disabled={isTyping}
                    className="bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 text-white px-5 rounded-xl transition-all flex items-center gap-2 font-bold shadow-lg"
                  >
                    <Send size={16} />
                    <span className="hidden sm:block">Test</span>
                  </button>
                </div>
              </div>
            </div>
          )}

          {activeStep === 2 && (
            <div className="p-8 fade-in-section overflow-y-auto custom-scrollbar">
              <h2 className="text-2xl font-bold mb-6 flex items-center gap-3">
                <Sparkles className="text-purple-400" /> Lab 3: Mega-Prompting
              </h2>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                {['ethos', 'logos', 'pathos'].map((type) => (
                  <div key={type} className="space-y-3">
                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                      <div className={`w-1.5 h-1.5 rounded-full ${type === 'ethos' ? 'bg-purple-500' : type === 'logos' ? 'bg-blue-500' : 'bg-emerald-500'}`}></div>
                      {type}
                    </label>
                    <textarea 
                      value={megaPrompt[type]}
                      onChange={(e) => setMegaPrompt({...megaPrompt, [type]: e.target.value})}
                      placeholder={`Enter ${type} details...`}
                      className="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-xs h-32 focus:ring-2 focus:ring-purple-500/50 outline-none transition-all resize-none"
                    />
                  </div>
                ))}
              </div>

              <div className="bg-slate-950 p-6 rounded-2xl border border-purple-500/10 shadow-2xl">
                <h4 className="text-[10px] font-black text-purple-400 uppercase tracking-widest mb-4">Assembled Instruction</h4>
                <div className="text-slate-400 font-mono text-xs leading-relaxed min-h-[60px]">
                  {megaPrompt.ethos || megaPrompt.logos || megaPrompt.pathos ? (
                    <div className="space-y-2">
                      {megaPrompt.ethos && <p><span className="text-slate-600 mr-2">ACT AS:</span>{megaPrompt.ethos}</p>}
                      {megaPrompt.logos && <p><span className="text-slate-600 mr-2">CONSTRAINTS:</span>{megaPrompt.logos}</p>}
                      {megaPrompt.pathos && <p><span className="text-slate-600 mr-2">TONE:</span>{megaPrompt.pathos}</p>}
                    </div>
                  ) : <span className="italic opacity-30">Waiting for components...</span>}
                </div>
              </div>
            </div>
          )}

          {activeStep === 3 && (
            <div className="p-8 fade-in-section h-full flex flex-col overflow-y-auto custom-scrollbar">
              <h2 className="text-2xl font-bold mb-6 flex items-center gap-3">
                <ShieldCheck className="text-red-400" /> Lab 4: Ethical Guardrails
              </h2>
              <div className="flex-1 space-y-6">
                <div className="bg-red-500/5 border border-red-500/10 p-6 rounded-2xl relative overflow-hidden">
                  <h3 className="font-bold text-red-400 mb-2">The Hidden Labor Audit</h3>
                  <p className="text-xs text-slate-400 leading-relaxed mb-4">
                    Following Fei-Fei Li's "Human-Centered" approach: How does your prompt account for the marginalized datasets or the labor of RLHF workers?
                  </p>
                </div>

                <div className="bg-slate-950 p-6 rounded-2xl border border-slate-800 shadow-inner">
                  <label className="block text-xs font-black text-slate-500 uppercase tracking-widest mb-4">Ethical Intervention</label>
                  <textarea 
                    value={guardrailInput}
                    onChange={(e) => setGuardrailInput(e.target.value)}
                    className="w-full bg-slate-900 border border-slate-800 rounded-xl p-5 text-sm text-slate-200 focus:ring-2 focus:ring-emerald-500/50 outline-none transition-all min-h-[150px]"
                    placeholder="Describe how you would adjust your prompt to mitigate systemic bias..."
                  />
                </div>
                
                <button 
                  onClick={generateReport}
                  className="w-full py-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-black rounded-xl flex items-center justify-center gap-3 transition-all shadow-lg active:scale-95"
                >
                  <FileText size={18} />
                  Compile Assignment Submission
                </button>
              </div>
            </div>
          )}
          
          {/* Controls */}
          <div className="mt-auto bg-slate-950/40 p-5 border-t border-slate-800/50 flex justify-between items-center">
            <div className="flex items-center gap-4">
              <div className="flex gap-1.5">
                {steps.map((_, i) => (
                  <div key={i} className={`h-1 rounded-full transition-all duration-300 ${activeStep === i ? 'w-6 bg-blue-500' : 'w-2 bg-slate-800'}`}></div>
                ))}
              </div>
              <span className="text-[10px] text-slate-600 uppercase font-bold hidden sm:inline">Module {activeStep + 1} of 4</span>
            </div>
            <div className="flex gap-2">
              <button 
                onClick={() => setActiveStep(prev => Math.max(0, prev - 1))}
                disabled={activeStep === 0}
                className="px-4 py-2 text-xs font-bold text-slate-400 hover:text-white disabled:opacity-0 transition-all"
              >
                Previous
              </button>
              <button 
                onClick={() => setActiveStep(prev => Math.min(steps.length - 1, prev + 1))}
                className={`px-6 py-2 rounded-lg text-xs font-black transition-all active:scale-95 ${
                  activeStep === steps.length - 1 
                  ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/20' 
                  : 'bg-slate-100 text-slate-900 hover:bg-white'
                }`}
              >
                {activeStep === steps.length - 1 ? 'Finish Lab' : 'Next Step'}
              </button>
            </div>
          </div>
        </section>
      </main>

      <footer className="max-w-6xl mx-auto mt-10 flex justify-between items-center text-slate-600 px-2">
        <p className="text-[10px] uppercase tracking-wider font-medium">Â© 2026 Rhetoric of Technology Lab</p>
        <button 
          onClick={() => triggerModal("Reset Progress", "This will clear all your inputs and chat history. Are you sure?")}
          className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest hover:text-red-400 transition-colors"
        >
          <RotateCcw size={12} /> Clear Session
        </button>
      </footer>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md animate-in fade-in duration-200">
          <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6 md:p-8 max-w-2xl w-full shadow-2xl relative overflow-hidden flex flex-col max-h-[85vh]">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-emerald-500"></div>
            
            <button 
              onClick={() => setShowModal(false)}
              className="absolute top-4 right-4 text-slate-500 hover:text-white transition-colors"
            >
              <X size={20} />
            </button>
            
            <h3 className="text-xl font-bold mb-4 flex items-center gap-3">
              {modalContent.isReport ? <ClipboardCheck className="text-emerald-400" /> : <Info className="text-blue-400" />}
              {modalContent.title}
            </h3>
            
            {modalContent.isReport ? (
              <div className="flex-1 overflow-y-auto mb-6 bg-slate-950 p-5 rounded-xl font-mono text-xs text-slate-400 whitespace-pre-wrap leading-relaxed border border-slate-800 custom-scrollbar">
                {modalContent.body}
              </div>
            ) : (
              <p className="text-slate-400 text-sm leading-relaxed mb-8">{modalContent.body}</p>
            )}
            
            <div className="flex justify-end gap-3 shrink-0">
              {modalContent.title === "Reset Progress" ? (
                <>
                  <button onClick={() => setShowModal(false)} className="px-5 py-2 text-xs font-bold text-slate-400">Cancel</button>
                  <button 
                    onClick={() => {
                      setChatHistory([]);
                      setMegaPrompt({ ethos: '', logos: '', pathos: '' });
                      setVectorInput("");
                      setGuardrailInput("");
                      setActiveStep(0);
                      setShowModal(false);
                    }}
                    className="px-6 py-2 rounded-lg text-xs font-bold bg-red-600 hover:bg-red-500 text-white transition-all"
                  >
                    Confirm Reset
                  </button>
                </>
              ) : (
                <div className="flex w-full sm:w-auto gap-3">
                   {modalContent.isReport && (
                     <button 
                        onClick={() => copyToClipboard(modalContent.body)}
                        className={`flex-1 sm:flex-none px-6 py-3 rounded-xl text-xs font-black flex items-center justify-center gap-2 transition-all ${
                          copied ? 'bg-emerald-500 text-white' : 'bg-blue-600 text-white hover:bg-blue-500 shadow-lg shadow-blue-900/20'
                        }`}
                      >
                        {copied ? <Check size={16} /> : <ClipboardCheck size={16} />}
                        {copied ? "Copied!" : "Copy Report"}
                      </button>
                   )}
                  <button 
                    onClick={() => setShowModal(false)}
                    className="flex-1 sm:flex-none px-6 py-3 rounded-xl text-xs font-black bg-slate-800 text-white hover:bg-slate-700"
                  >
                    Dismiss
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
